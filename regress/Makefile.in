# **********************************************************************
# *
# * PostGIS - Spatial Types for PostgreSQL
# * http://postgis.net
# *
# * Copyright (C) 2018 Sandro Santilli <strk@kbt.io>
# *
# * This is free software; you can redistribute and/or modify it under
# * the terms of the GNU General Public Licence. See the COPYING file.
# *
# **********************************************************************

PERL=@PERL@
MINGWBUILD=@MINGWBUILD@
HAVE_SFCGAL=@HAVE_SFCGAL@

POSTGIS_MAJOR_VERSION=@POSTGIS_MAJOR_VERSION@
POSTGIS_MINOR_VERSION=@POSTGIS_MINOR_VERSION@
POSTGIS_MICRO_VERSION=@POSTGIS_MICRO_VERSION@

topsrcdir = $(realpath ../)

# Where we put our regression installation
ifeq ($(MINGWBUILD),1)
	srcdir=$(shell bash -c "pwd -W")
else
	srcdir=$(shell pwd)
endif
REGRESS_INSTALLDIR=$(srcdir)/00-regress-install

# MingW hack: rather than use PGSQL_BINDIR directly, we change to the directory and
# then use "pwd" to return the path. This ensures that the returned path is in MSYS
# format, otherwise colons in drive letters will break PATH.
PGSQL_BINDIR=$(shell cd "@PGSQL_BINDIR@" && pwd)

#
# Put path from pg_config into front of search path
#
PATH := $(PGSQL_BINDIR):$(PATH)
export PATH

all install uninstall:

check: check-regress

check-unit:

include core/tests.mk
include loader/tests.mk
include dumper/tests.mk
ifeq ($(HAVE_SFCGAL),yes)
	override RUNTESTFLAGS := $(RUNTESTFLAGS) --sfcgal
	include sfcgal/tests.mk
endif

include runtest.mk

clean:
	rm -rf $(REGRESS_INSTALLDIR)
	rm -f postgis_garden_result.txt

distclean: clean
	rm -f Makefile
	rm -f core/Makefile
	rm -f loader/Makefile
	rm -f dumper/Makefile
	rm -f sfcgal/Makefile

staged-install:
	$(MAKE) -C .. REGRESS=1 DESTDIR=$(REGRESS_INSTALLDIR) install

garden: staged-install
	createdb postgis_garden
	createlang plpgsql postgis_garden || true #tolerate an error here
	psql --no-psqlrc --variable ON_ERROR_STOP=true -d postgis_garden < $(REGRESS_INSTALLDIR)/share/contrib/postgis/postgis.sql && \
	psql --no-psqlrc --variable ON_ERROR_STOP=true -d postgis_garden < $(REGRESS_INSTALLDIR)/share/contrib/postgis/spatial_ref_sys.sql || true # tolerate an error here
	psql --no-psqlrc --variable ON_ERROR_STOP=true -d postgis_garden < $(REGRESS_INSTALLDIR)/share/contrib/postgis/rtpostgis.sql || true #tolerate an error here
	@echo '-------------------------------------------------'
	@echo 'Regression tests in progress (it will take time)'
	@echo 'Result output: ./regress/postgis_garden_result.txt'
	@echo '-------------------------------------------------'
	psql --no-psqlrc -ad postgis_garden < ../doc/postgis_gardentest_${POSTGIS_MAJOR_VERSION}${POSTGIS_MINOR_VERSION}.sql > postgis_garden_result.txt 2>&1
	tail postgis_garden_result.txt
	psql --no-psqlrc -ad postgis_garden < ../doc/raster_gardentest_${POSTGIS_MAJOR_VERSION}${POSTGIS_MINOR_VERSION}.sql > raster_garden_result.txt 2>&1
	tail raster_garden_result.txt
	#dropdb postgis_garden
